{"ast":null,"code":"'use strict';\n\nvar _regeneratorRuntime = require(\"/Users/mikebannoura/Dropbox/My Mac (MacBook-Pro-Mike.local)/Desktop/mmbball-app/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\");\n\nvar _asyncToGenerator = require(\"/Users/mikebannoura/Dropbox/My Mac (MacBook-Pro-Mike.local)/Desktop/mmbball-app/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/asyncToGenerator\");\n\nvar _createForOfIteratorHelper = require(\"/Users/mikebannoura/Dropbox/My Mac (MacBook-Pro-Mike.local)/Desktop/mmbball-app/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createForOfIteratorHelper\");\n\nvar _classCallCheck = require(\"/Users/mikebannoura/Dropbox/My Mac (MacBook-Pro-Mike.local)/Desktop/mmbball-app/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/Users/mikebannoura/Dropbox/My Mac (MacBook-Pro-Mike.local)/Desktop/mmbball-app/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createClass\");\n\nvar PDF = require('./object');\n\nvar Parser = require('./parser/parser');\n\nvar PROPERTIES_TO_COPY = {\n  colorSpaces: 'ColorSpace',\n  fonts: 'Font',\n  xobjects: 'XObject',\n  extGStates: 'ExtGState',\n  shadings: 'Shading'\n};\n\nmodule.exports = /*#__PURE__*/function () {\n  function ExternalDocument(src) {\n    _classCallCheck(this, ExternalDocument);\n\n    var parser = new Parser(src);\n    parser.parse();\n    var catalog = parser.trailer.get('Root').object.properties;\n    var pages = catalog.get('Pages').object.properties;\n    this.pages = pages;\n    this.mediaBox = pages.get('MediaBox');\n    var kids = pages.get('Kids');\n    this.pageCount = this._countPagesRecursively(kids, 0);\n  }\n\n  _createClass(ExternalDocument, [{\n    key: \"_countPagesRecursively\",\n    value: function _countPagesRecursively(kids, i) {\n      var _iterator = _createForOfIteratorHelper(kids),\n          _step;\n\n      try {\n        for (_iterator.s(); !(_step = _iterator.n()).done;) {\n          var kid = _step.value;\n          var page = kid.object;\n\n          if (page.properties.get('Type').toString() === '/Pages') {\n            // encountered nested pages\n            i = this._countPagesRecursively(page.properties.get('Kids'), i);\n          } else {\n            i++;\n          }\n        }\n      } catch (err) {\n        _iterator.e(err);\n      } finally {\n        _iterator.f();\n      }\n\n      return i;\n    } // TODO: add mutex to not write concurrently (because of document specific _registerObject)\n\n  }, {\n    key: \"write\",\n    value: function () {\n      var _write = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(doc, page) {\n        var kids, filter, _iterator2, _step2, _page, objects, _i, _objects, obj, _i2, _objects2, _obj;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return doc._endPage();\n\n              case 2:\n                kids = this.pages.get('Kids');\n                filter = page ? function (i) {\n                  return i === page - 1;\n                } : undefined;\n                _iterator2 = _createForOfIteratorHelper(this._iterPagesRecursively(doc, kids, filter));\n                _context.prev = 5;\n\n                _iterator2.s();\n\n              case 7:\n                if ((_step2 = _iterator2.n()).done) {\n                  _context.next = 28;\n                  break;\n                }\n\n                _page = _step2.value;\n\n                // if the page object does not define its MediaBox, explicitly set its MediaBox to the\n                // value defined by its parent Pages object\n                if (!_page.properties.has('MediaBox') && this.mediaBox) {\n                  _page.properties.set('MediaBox', this.mediaBox);\n                } // add single page\n\n\n                doc._registerObject(_page, true); // first, register objects to assign IDs (for references)\n\n\n                objects = [];\n                Parser.addObjectsRecursive(objects, _page, 0);\n\n                for (_i = 0, _objects = objects; _i < _objects.length; _i++) {\n                  obj = _objects[_i];\n\n                  doc._registerObject(obj, true);\n                } // write objects\n\n\n                _i2 = 0, _objects2 = objects;\n\n              case 15:\n                if (!(_i2 < _objects2.length)) {\n                  _context.next = 22;\n                  break;\n                }\n\n                _obj = _objects2[_i2];\n                _context.next = 19;\n                return doc._writeObject(_obj);\n\n              case 19:\n                _i2++;\n                _context.next = 15;\n                break;\n\n              case 22:\n                _page.prop('Parent', doc._pagesObj.toReference());\n\n                _context.next = 25;\n                return doc._writeObject(_page);\n\n              case 25:\n                doc._pages.push(_page.toReference());\n\n              case 26:\n                _context.next = 7;\n                break;\n\n              case 28:\n                _context.next = 33;\n                break;\n\n              case 30:\n                _context.prev = 30;\n                _context.t0 = _context[\"catch\"](5);\n\n                _iterator2.e(_context.t0);\n\n              case 33:\n                _context.prev = 33;\n\n                _iterator2.f();\n\n                return _context.finish(33);\n\n              case 36:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this, [[5, 30, 33, 36]]);\n      }));\n\n      function write(_x, _x2) {\n        return _write.apply(this, arguments);\n      }\n\n      return write;\n    }()\n  }, {\n    key: \"_iterPagesRecursively\",\n    value: /*#__PURE__*/_regeneratorRuntime.mark(function _iterPagesRecursively(doc, kids, filter, cursor) {\n      var _iterator3, _step3, kid, page;\n\n      return _regeneratorRuntime.wrap(function _iterPagesRecursively$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              if (!cursor) {\n                cursor = {\n                  i: 0\n                };\n              }\n\n              _iterator3 = _createForOfIteratorHelper(kids);\n              _context2.prev = 2;\n\n              _iterator3.s();\n\n            case 4:\n              if ((_step3 = _iterator3.n()).done) {\n                _context2.next = 18;\n                break;\n              }\n\n              kid = _step3.value;\n              page = kid.object;\n\n              if (!(page.properties.get('Type').toString() === '/Pages')) {\n                _context2.next = 12;\n                break;\n              }\n\n              return _context2.delegateYield(this._iterPagesRecursively(doc, page.properties.get('Kids'), filter, cursor), \"t0\", 9);\n\n            case 9:\n              return _context2.abrupt(\"continue\", 16);\n\n            case 12:\n              if (!(!filter || filter(cursor.i))) {\n                _context2.next = 15;\n                break;\n              }\n\n              _context2.next = 15;\n              return page;\n\n            case 15:\n              cursor.i++;\n\n            case 16:\n              _context2.next = 4;\n              break;\n\n            case 18:\n              _context2.next = 23;\n              break;\n\n            case 20:\n              _context2.prev = 20;\n              _context2.t1 = _context2[\"catch\"](2);\n\n              _iterator3.e(_context2.t1);\n\n            case 23:\n              _context2.prev = 23;\n\n              _iterator3.f();\n\n              return _context2.finish(23);\n\n            case 26:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _iterPagesRecursively, this, [[2, 20, 23, 26]]);\n    })\n  }, {\n    key: \"setAsTemplate\",\n    value: function () {\n      var _setAsTemplate = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(doc, firstPageOnly) {\n        var filter, kids, _iterator4, _step4, page, first, objects, _i3, _objects3, obj, _i4, _objects4, _obj2, contents, resources, prop, dict, alias;\n\n        return _regeneratorRuntime.wrap(function _callee2$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _context3.next = 2;\n                return doc._endPage();\n\n              case 2:\n                // take the first page only\n                filter = function filter(i) {\n                  return i === 0;\n                };\n\n                kids = this.pages.get('Kids');\n\n                if (kids[0]) {\n                  _context3.next = 6;\n                  break;\n                }\n\n                throw new TypeError('External document is invalid');\n\n              case 6:\n                _iterator4 = _createForOfIteratorHelper(this._iterPagesRecursively(doc, kids, filter));\n                _context3.prev = 7;\n\n                _iterator4.s();\n\n              case 9:\n                if ((_step4 = _iterator4.n()).done) {\n                  _context3.next = 33;\n                  break;\n                }\n\n                page = _step4.value;\n\n                // if the page object does not define its MediaBox, explicitly set its MediaBox to the\n                // value defined by its parent Pages object\n                if (!page.properties.has('MediaBox') && this.mediaBox) {\n                  page.properties.set('MediaBox', this.mediaBox);\n                }\n\n                first = page.properties;\n                objects = [];\n                Parser.addObjectsRecursive(objects, page, 0); // first, register objects to assign IDs (for references)\n\n                for (_i3 = 0, _objects3 = objects; _i3 < _objects3.length; _i3++) {\n                  obj = _objects3[_i3];\n\n                  doc._registerObject(obj, true);\n                } // write objects\n\n\n                _i4 = 0, _objects4 = objects;\n\n              case 17:\n                if (!(_i4 < _objects4.length)) {\n                  _context3.next = 24;\n                  break;\n                }\n\n                _obj2 = _objects4[_i4];\n                _context3.next = 21;\n                return doc._writeObject(_obj2);\n\n              case 21:\n                _i4++;\n                _context3.next = 17;\n                break;\n\n              case 24:\n                contents = first.get('Contents');\n\n                if (!Array.isArray(contents)) {\n                  contents = [contents];\n                }\n\n                resources = first.get('Resources');\n\n                if (resources instanceof PDF.Reference) {\n                  resources = resources.object.properties;\n                }\n\n                doc._template = {\n                  contents: contents.map(function (c) {\n                    return c && c.toString() || '';\n                  }),\n                  colorSpaces: {},\n                  fonts: {},\n                  xobjects: {},\n                  extGStates: {},\n                  shadings: {}\n                };\n\n                for (prop in PROPERTIES_TO_COPY) {\n                  dict = resources && resources.get(PROPERTIES_TO_COPY[prop]);\n\n                  if (dict) {\n                    for (alias in dict.dictionary) {\n                      doc._template[prop][alias] = dict.dictionary[alias].toString();\n\n                      doc._aliases.block(alias);\n                    }\n                  }\n                }\n\n                doc._template.firstPageOnly = firstPageOnly;\n\n              case 31:\n                _context3.next = 9;\n                break;\n\n              case 33:\n                _context3.next = 38;\n                break;\n\n              case 35:\n                _context3.prev = 35;\n                _context3.t0 = _context3[\"catch\"](7);\n\n                _iterator4.e(_context3.t0);\n\n              case 38:\n                _context3.prev = 38;\n\n                _iterator4.f();\n\n                return _context3.finish(38);\n\n              case 41:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee2, this, [[7, 35, 38, 41]]);\n      }));\n\n      function setAsTemplate(_x3, _x4) {\n        return _setAsTemplate.apply(this, arguments);\n      }\n\n      return setAsTemplate;\n    }()\n  }, {\n    key: \"_getPagesRecursively\",\n    value: function () {\n      var _getPagesRecursively2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(doc, kids, i, filter) {\n        var _iterator5, _step5, kid, page, objects, _i5, _objects5, obj, _i6, _objects6, _obj3;\n\n        return _regeneratorRuntime.wrap(function _callee3$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                _iterator5 = _createForOfIteratorHelper(kids);\n                _context4.prev = 1;\n\n                _iterator5.s();\n\n              case 3:\n                if ((_step5 = _iterator5.n()).done) {\n                  _context4.next = 34;\n                  break;\n                }\n\n                kid = _step5.value;\n                page = kid.object;\n\n                if (!(page.properties.get('Type').toString() === '/Pages')) {\n                  _context4.next = 13;\n                  break;\n                }\n\n                _context4.next = 9;\n                return this._addPagesRecursively(doc, page.properties.get('Kids'), i, filter);\n\n              case 9:\n                i = _context4.sent;\n                return _context4.abrupt(\"continue\", 32);\n\n              case 13:\n                if (!(!filter || filter(i))) {\n                  _context4.next = 31;\n                  break;\n                }\n\n                // if the page object does not define its MediaBox, explicitly set its MediaBox to the\n                // value defined by its parent Pages object\n                if (!page.properties.has('MediaBox') && this.mediaBox) {\n                  page.properties.set('MediaBox', this.mediaBox);\n                } // add single page\n\n\n                doc._registerObject(page, true); // first, register objects to assign IDs (for references)\n\n\n                objects = [];\n                Parser.addObjectsRecursive(objects, page, 0);\n\n                for (_i5 = 0, _objects5 = objects; _i5 < _objects5.length; _i5++) {\n                  obj = _objects5[_i5];\n\n                  doc._registerObject(obj, true);\n                } // write objects\n\n\n                _i6 = 0, _objects6 = objects;\n\n              case 20:\n                if (!(_i6 < _objects6.length)) {\n                  _context4.next = 27;\n                  break;\n                }\n\n                _obj3 = _objects6[_i6];\n                _context4.next = 24;\n                return doc._writeObject(_obj3);\n\n              case 24:\n                _i6++;\n                _context4.next = 20;\n                break;\n\n              case 27:\n                page.prop('Parent', doc._pagesObj.toReference());\n                _context4.next = 30;\n                return doc._writeObject(page);\n\n              case 30:\n                doc._pages.push(page.toReference());\n\n              case 31:\n                i++;\n\n              case 32:\n                _context4.next = 3;\n                break;\n\n              case 34:\n                _context4.next = 39;\n                break;\n\n              case 36:\n                _context4.prev = 36;\n                _context4.t0 = _context4[\"catch\"](1);\n\n                _iterator5.e(_context4.t0);\n\n              case 39:\n                _context4.prev = 39;\n\n                _iterator5.f();\n\n                return _context4.finish(39);\n\n              case 42:\n                return _context4.abrupt(\"return\", i);\n\n              case 43:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee3, this, [[1, 36, 39, 42]]);\n      }));\n\n      function _getPagesRecursively(_x5, _x6, _x7, _x8) {\n        return _getPagesRecursively2.apply(this, arguments);\n      }\n\n      return _getPagesRecursively;\n    }()\n  }]);\n\n  return ExternalDocument;\n}();","map":{"version":3,"sources":["/Users/mikebannoura/Dropbox/My Mac (MacBook-Pro-Mike.local)/Desktop/mmbball-app/client/node_modules/pdfjs/lib/external.js"],"names":["PDF","require","Parser","PROPERTIES_TO_COPY","colorSpaces","fonts","xobjects","extGStates","shadings","module","exports","src","parser","parse","catalog","trailer","get","object","properties","pages","mediaBox","kids","pageCount","_countPagesRecursively","i","kid","page","toString","doc","_endPage","filter","undefined","_iterPagesRecursively","has","set","_registerObject","objects","addObjectsRecursive","obj","_writeObject","prop","_pagesObj","toReference","_pages","push","cursor","firstPageOnly","TypeError","first","contents","Array","isArray","resources","Reference","_template","map","c","dict","alias","dictionary","_aliases","block","_addPagesRecursively"],"mappings":"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","sourcesContent":["'use strict'\n\nconst PDF = require('./object')\nconst Parser = require('./parser/parser')\n\nconst PROPERTIES_TO_COPY = {\n  colorSpaces: 'ColorSpace',\n  fonts: 'Font',\n  xobjects: 'XObject',\n  extGStates: 'ExtGState',\n  shadings: 'Shading',\n}\n\nmodule.exports = class ExternalDocument {\n  constructor(src) {\n    const parser = new Parser(src)\n    parser.parse()\n\n    const catalog  = parser.trailer.get('Root').object.properties\n    const pages    = catalog.get('Pages').object.properties\n\n    this.pages = pages\n    this.mediaBox = pages.get('MediaBox')\n\n    const kids = pages.get('Kids')\n    this.pageCount = this._countPagesRecursively(kids, 0)\n  }\n\n  _countPagesRecursively(kids, i) {\n    for (const kid of kids) {\n      const page = kid.object\n      if (page.properties.get('Type').toString() === '/Pages') {\n        // encountered nested pages\n        i = this._countPagesRecursively(page.properties.get('Kids'), i)\n      } else {\n        i++\n      }\n    }\n\n    return i\n  }\n\n  // TODO: add mutex to not write concurrently (because of document specific _registerObject)\n  async write(doc, page) {\n    await doc._endPage()\n\n    const kids = this.pages.get('Kids')\n    const filter = page ? ((i) => i === (page - 1)) : undefined\n\n    for (const page of this._iterPagesRecursively(doc, kids, filter)) {\n      // if the page object does not define its MediaBox, explicitly set its MediaBox to the\n      // value defined by its parent Pages object\n      if (!page.properties.has('MediaBox') && this.mediaBox) {\n        page.properties.set('MediaBox', this.mediaBox)\n      }\n\n      // add single page\n      doc._registerObject(page, true)\n\n      // first, register objects to assign IDs (for references)\n      const objects = []\n      Parser.addObjectsRecursive(objects, page, 0)\n      for (const obj of objects) {\n        doc._registerObject(obj, true)\n      }\n\n      // write objects\n      for (const obj of objects) {\n        await doc._writeObject(obj)\n      }\n\n      page.prop('Parent', doc._pagesObj.toReference())\n      await doc._writeObject(page)\n\n      doc._pages.push(page.toReference())\n    }\n  }\n\n  * _iterPagesRecursively(doc, kids, filter, cursor) {\n    if (!cursor) {\n      cursor = { i: 0 }\n    }\n\n    for (const kid of kids) {\n      const page = kid.object\n\n      if (page.properties.get('Type').toString() === '/Pages') {\n        // encountered nested pages\n        yield* this._iterPagesRecursively(doc, page.properties.get('Kids'), filter, cursor)\n        continue\n      } else if (!filter || filter(cursor.i)) {\n        yield page\n      }\n\n      cursor.i++\n    }\n  }\n\n  async setAsTemplate(doc, firstPageOnly) {\n    await doc._endPage()\n\n    // take the first page only\n    const filter = i => i === 0\n    const kids = this.pages.get('Kids')\n    if (!kids[0]) {\n      throw new TypeError('External document is invalid')\n    }\n\n    for (const page of this._iterPagesRecursively(doc, kids, filter)) {\n      // if the page object does not define its MediaBox, explicitly set its MediaBox to the\n      // value defined by its parent Pages object\n      if (!page.properties.has('MediaBox') && this.mediaBox) {\n        page.properties.set('MediaBox', this.mediaBox)\n      }\n      const first = page.properties\n      const objects = []\n      Parser.addObjectsRecursive(objects, page, 0)\n\n      // first, register objects to assign IDs (for references)\n      for (const obj of objects) {\n        doc._registerObject(obj, true)\n      }\n\n      // write objects\n      for (const obj of objects) {\n        await doc._writeObject(obj)\n      }\n\n      let contents = first.get('Contents')\n      if (!Array.isArray(contents)) {\n        contents = [contents]\n      }\n\n      let resources = first.get('Resources')\n      if (resources instanceof PDF.Reference) {\n      resources = resources.object.properties\n      }\n\n      doc._template = {\n        contents: contents.map(c => ((c && c.toString()) || '')),\n        colorSpaces: {},\n        fonts: {},\n        xobjects: {},\n        extGStates: {},\n        shadings: {},\n      }\n\n      for (const prop in PROPERTIES_TO_COPY) {\n        const dict = resources && resources.get(PROPERTIES_TO_COPY[prop])\n        if (dict) {\n          for (const alias in dict.dictionary) {\n            doc._template[prop][alias] = dict.dictionary[alias].toString()\n            doc._aliases.block(alias)\n          }\n        }\n      }\n\n      doc._template.firstPageOnly = firstPageOnly\n    }\n  }\n\n  async _getPagesRecursively(doc, kids, i, filter) {\n    for (const kid of kids) {\n      const page = kid.object\n\n      if (page.properties.get('Type').toString() === '/Pages') {\n        // encountered nested pages\n        i = await this._addPagesRecursively(doc, page.properties.get('Kids'), i, filter)\n        continue\n      } else if (!filter || filter(i)) {\n        // if the page object does not define its MediaBox, explicitly set its MediaBox to the\n        // value defined by its parent Pages object\n        if (!page.properties.has('MediaBox') && this.mediaBox) {\n          page.properties.set('MediaBox', this.mediaBox)\n        }\n\n        // add single page\n        doc._registerObject(page, true)\n\n        // first, register objects to assign IDs (for references)\n        const objects = []\n        Parser.addObjectsRecursive(objects, page, 0)\n        for (const obj of objects) {\n          doc._registerObject(obj, true)\n        }\n\n        // write objects\n        for (const obj of objects) {\n          await doc._writeObject(obj)\n        }\n\n        page.prop('Parent', doc._pagesObj.toReference())\n        await doc._writeObject(page)\n\n        doc._pages.push(page.toReference())\n      }\n\n      i++\n    }\n\n    return i\n  }\n}\n\n\n"]},"metadata":{},"sourceType":"script"}